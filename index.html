
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Michael Pearson</title>
  <meta name="author" content="Michael Pearson">

  
  <meta name="description" content="By &#8221;destructive&#8221;, I mean &#8220;removes or renames a column in use by the current application&#8221;. By &#8221;live&#8221;, I mean &# &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mipearson.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/coffee-script.js"></script>
  <script type="text/coffeescript" src="/javascripts/bg.coffee"></script>
  <link href="/atom.xml" rel="alternate" title="Michael Pearson" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17899518-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div  id="body"  >
  
    <header role="banner"><hgroup>
  <h1><a href="/">Michael Pearson</a></h1>
  
    <h2>Systems Automation and Web Development</h2>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mipearson.github.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/">Live Destructive Database Migrations: Doing the Two Step</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-08T07:43:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>By &#8221;<strong>destructive</strong>&#8221;, I mean &#8220;removes or renames a column in use by the current application&#8221;. By &#8221;<strong>live</strong>&#8221;, I mean &#8220;while your application is in use&#8221;.</p>

<h2>Original Migration</h2>

<p>If Rails&#8217; ActiveRecord notices that a table has the columns <code>created_at</code> and <code>updated_at</code> it will automatically populate or change their values on model creation or modification. Our application doesn&#8217;t take advantage of this: it uses a hand-rolled <code>creation_date</code> field. I&#8217;m going to change this column to <code>created_at</code> and add an <code>updated_at</code> column.</p>

<p>If I were doing this via downtime and maintenance page the migration would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddCreatedUpdatedColumns</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2"> SET updated_at = created_at&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This migration couldn&#8217;t be run on a live system. Between the time that the schema begins to be changed and the application restarts these errors would occur:</p>

<ul>
<li>ActiveRecord would try to set values on a creation_date column that no longer exists</li>
<li>Scopes that have <code>order(:creation_date)</code> stanzas would fail to load entirely</li>
</ul>


<h2>Do the Two-Step</h2>

<p>To work around this I&#8217;m going to split the above migration and prepare for multiple deployments:</p>

<ul>
<li><p>My first migration will create new <code>created_at</code> and <code>updated_at</code> columns and deploy code to use these new columns instead.</p></li>
<li><p>My second migration will remove the now unused <code>creation_date</code> column.</p></li>
</ul>


<p>Simple, yeah? I let our running application use the new column name before I remove the old one.</p>

<h3>Our First Migration</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddCreatedUpdatedColums</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="s2">&quot;DEFAULT now() NOT NULL&quot;</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="s2">&quot;DEFAULT now() NOT NULL&quot;</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2"> SET created_at = creation_date, updated_at = creation_date&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once I&#8217;ve run <code>rake db:migrate</code>  on my development box I&#8217;ll run a global find and replace all instances of <code>creation_date</code> with <code>created_at</code>. I&#8217;ll then run our test suite and commit.</p>

<p>I&#8217;ll push that out to our test system, play around with some records to make sure that <code>created_at</code> and <code>updated_at</code> get set properly, and then push it to production.</p>

<h3>Our Second Migration</h3>

<p>In the above case the first migration would take up to five minutes to run on our slow fixed HDDs in production. While it was running I created a branch to write our second migration, just in case I needed to fix something in <code>master</code> before pushing this new migration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">RemoveCreationDate</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{some tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">IrreversibleMigration</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the use of <code>IrreversibleMigration</code> above. I prefer to flag that a migration can&#8217;t be reversed this way rather than leave a <code>down</code> method that provides a false positive. I will also remove the <code>DEFAULT now()</code>: ActiveRecord will always set these values, any other behaviour should be considered an error.</p>

<p>This migration gets pushed to our test system only when the first migration and deploy has successfully run on both our test and production systems and all automated tests have passed.</p>

<h2>Gotchas</h2>

<p>The code above has been adapted based on a couple of things that went wrong during pre-production testing:</p>

<ul>
<li>The created columns were set to <code>:null =&gt; true</code> rather than having intelligent defaults. This gave us some grief after the first migration was run: some code depended on <code>creation_date</code> &amp; <code>created_at</code> not being nil.</li>
<li>I&#8217;d forgotten to change <code>creation_date</code> to allow nulls in the first migration. This meant that once the new code was deployed records were being saved without a <code>creation_date</code>, causing MySQL to return a <code>column 'creation_date' cannot be NULL</code> failure.</li>
</ul>


<p>I also had to modify an existing index and manually re-create a couple of views. Check your <code>db/schema.rb</code> diff after you run <code>rake migrate</code> on your own machine before pushing.</p>

<p>In our codebase migrations are immutable one they hit pre-production, so they&#8217;re there for other BikeExchange developers to point and laugh forever (or until the next old-migrations purge).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/30/babushka/">Babushka, Day Two</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-30T00:00:00+10:00" pubdate data-updated="true">Sep 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Add logging to timezone set</h2>

<p>I&#8217;d like to know that we&#8217;ve actually set the timezone correctly, and Babushka&#8217;s console output is lovely. Let&#8217;s add to that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;timezone set&quot;</span><span class="p">,</span> <span class="ss">:timezone</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">current_tz</span> <span class="o">=</span> <span class="n">shell</span><span class="p">(</span><span class="s2">&quot;date +%Z&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">log</span> <span class="s2">&quot;system timezone is </span><span class="si">#{</span><span class="n">current_tz</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">current_tz</span> <span class="o">==</span> <span class="n">timezone</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">meet</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;/etc/timezone&#39;</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>
</span><span class='line'>    <span class="n">shell</span> <span class="s2">&quot;dpkg-reconfigure --frontend noninteractive tzdata&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@precise64:~# babushka <span class="s2">&quot;personal:timezone set&quot;</span> <span class="nv">timezone</span><span class="o">=</span>UTC
</span><span class='line'>timezone <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>  System timezone is EST
</span><span class='line'>  meet <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  System timezone is UTC
</span><span class='line'><span class="o">}</span> ✓ timezone <span class="nb">set</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Remove AppArmor</h2>

<p>I dislike AppArmor. I find it gets in the way more than it assists. Let&#8217;s nuke it.</p>

<p>Is it installed by default in Ubuntu 12.04?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@precise64:~# dpkg -l | grep apparmor
</span><span class='line'>ii  apparmor                        2.7.102-0ubuntu3           User-space parser utility <span class="k">for </span>AppArmor
</span></code></pre></td></tr></table></div></figure>


<p>Yep. Okay, how do we work out whether a package is installed? Diving into the babushka source shows us <code>PkgHelper</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;remove apparmor&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="o">!</span> <span class="no">Babushka</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">pkg_helper</span><span class="o">.</span><span class="n">has?</span><span class="p">(</span><span class="s1">&#39;apparmor&#39;</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>remove apparmor <span class="o">{</span>
</span><span class='line'>  ✓ system has apparmor deb
</span><span class='line'>  meet <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  ✓ system has apparmor deb
</span><span class='line'><span class="o">}</span> ✗ remove apparmor
</span></code></pre></td></tr></table></div></figure>


<p><code>PkgHelper</code> unfortunaely has no &#8220;remove package&#8221; function. We&#8217;ll shell out instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;remove apparmor&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="o">!</span> <span class="no">Babushka</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">pkg_helper</span><span class="o">.</span><span class="n">has?</span><span class="p">(</span><span class="s1">&#39;apparmor&#39;</span><span class="p">)}</span>
</span><span class='line'>  <span class="n">meet</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">shell</span> <span class="s2">&quot;apt-get remove -y apparmor&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@precise64:~# babushka <span class="s2">&quot;personal:remove apparmor&quot;</span>
</span><span class='line'>remove apparmor <span class="o">{</span>
</span><span class='line'>  ✓ system has apparmor deb
</span><span class='line'>  meet <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  system doesn<span class="err">&#39;</span>t have apparmor deb
</span><span class='line'><span class="o">}</span> ✓ remove apparmor
</span></code></pre></td></tr></table></div></figure>


<h2>Make sure we have our standard utility suite</h2>

<p>Our chef base cookbook installs a bunch of packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Packages</span>
</span><span class='line'><span class="sx">%w{</span>
</span><span class='line'><span class="sx">  build-essential binutils-doc autoconf flex bison</span>
</span><span class='line'><span class="sx">  vim curl git-core sysstat libxml2-dev libxslt1-dev</span>
</span><span class='line'><span class="sx">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="n">package</span> <span class="nb">p</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">action</span> <span class="ss">:install</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, I can&#8217;t remember exactly <em>why</em> some of these got installed. A couple of them are for Ruby, but we&#8217;ll install those later. I&#8217;m going to filter the above list and use babushka&#8217;s <code>.bin</code> template:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s1">&#39;vim.bin&#39;</span>
</span><span class='line'><span class="n">dep</span> <span class="s1">&#39;git.bin&#39;</span>
</span><span class='line'><span class="n">dep</span> <span class="s1">&#39;curl.bin&#39;</span>
</span><span class='line'><span class="n">dep</span> <span class="s1">&#39;iostat.bin&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">installs</span> <span class="s1">&#39;sysstat&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">dep</span> <span class="s2">&quot;standard binaries&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">requires</span> <span class="sx">%w{vim.bin git.bin curl.bin iostat.bin}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the <code>installs 'sysstat'</code>: the <code>.bin</code> template checks for the existence of the binary and installs the package of the same name if it doesn&#8217;t exist. This won&#8217;t work for <code>iostat</code>, which comes from the <code>sysstat</code> package.</p>

<p>And run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@precise64:~# babushka  <span class="s2">&quot;personal:standard binaries&quot;</span>
</span><span class='line'>standard binaries <span class="o">{</span>
</span><span class='line'>  vim.bin <span class="o">{</span>
</span><span class='line'>    <span class="s1">&#39;vim&#39;</span> runs from /usr/bin.
</span><span class='line'>  <span class="o">}</span> ✓ vim.bin
</span><span class='line'>  git.bin <span class="o">{</span>
</span><span class='line'>    <span class="s1">&#39;git&#39;</span> runs from /usr/bin.
</span><span class='line'>  <span class="o">}</span> ✓ git.bin
</span><span class='line'>  curl.bin <span class="o">{</span>
</span><span class='line'>    <span class="s1">&#39;curl&#39;</span> runs from /usr/bin.
</span><span class='line'>  <span class="o">}</span> ✓ curl.bin
</span><span class='line'>  iostat.bin <span class="o">{</span>
</span><span class='line'>    <span class="s1">&#39;iostat&#39;</span> is missing.
</span><span class='line'>    apt <span class="o">{</span>
</span><span class='line'>      package manager <span class="o">{</span>
</span><span class='line'>        <span class="s1">&#39;apt-get&#39;</span> runs from /usr/bin.
</span><span class='line'>      <span class="o">}</span> ✓ package manager
</span><span class='line'>      apt <span class="nb">source</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">}</span> ✓ apt <span class="nb">source</span>
</span><span class='line'><span class="nb">      </span>apt <span class="nb">source</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">}</span> ✓ apt <span class="nb">source</span>
</span><span class='line'>    <span class="o">}</span> ✓ apt
</span><span class='line'>    meet <span class="o">{</span>
</span><span class='line'>      Installing sysstat via apt... <span class="k">done</span>.
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="s1">&#39;iostat&#39;</span> runs from /usr/bin.
</span><span class='line'>  <span class="o">}</span> ✓ iostat.bin
</span><span class='line'><span class="o">}</span> ✓ standard binaries
</span></code></pre></td></tr></table></div></figure>


<p>Gold.</p>

<h2>NTP</h2>

<p>We ensure that NTP is installed and talking to some Australian time servers to keep our clocks in sync. Our chef cookbook looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s1">&#39;ntp&#39;</span> <span class="c1"># Install ntp package</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;ntp&#39;</span> <span class="k">do</span> <span class="c1"># Ensure that ntp starts on boot</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:enable</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">cookbook_file</span> <span class="s2">&quot;/etc/ntp.conf&quot;</span> <span class="k">do</span> <span class="c1"># Tell NTP to use .au time servers</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[ntp]&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Skipping right to the end, here&#8217;s the babushka version I ended up settling on:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s1">&#39;ntpd.bin&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">installs</span> <span class="s1">&#39;ntp&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">dep</span> <span class="s2">&quot;ntp time synchronisation&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">requires</span> <span class="s1">&#39;ntpd.bin&#39;</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="no">Babushka</span><span class="o">::</span><span class="no">Renderable</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;/etc/ntp.conf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">from?</span><span class="p">(</span><span class="n">dependency</span><span class="o">.</span><span class="n">load_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;ntp/ntp.conf&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">meet</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">render_erb</span> <span class="s1">&#39;ntp/ntp.conf&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;/etc/ntp.conf&#39;</span>
</span><span class='line'>    <span class="n">shell</span> <span class="s2">&quot;service ntp restart&quot;</span>
</span><span class='line'>    <span class="nb">sleep</span> <span class="mi">1</span> <span class="c1"># wait for ntp to come back up</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This originally had a <code>ntpq -p</code> test to make sure NTP was using the time servers we asked it to. Unfortunately, we use the <code>#.oceania.pool.ntp.org</code> aliases, and <code>ntpq -p</code> would only output the servers they actually CNAMEd to. An alternative would be to test for latency, but that&#8217;s too much effort for a small requirement like this.</p>

<p>The <code>Babushka::Renderable</code> stuff is stolen from The Conversation&#8217;s <a href="https://github.com/conversation/babushka-deps">babushka-deps</a>. The <code>met?</code> condition fails if the rendered template would not match the template currently present.</p>

<p>Personally, I&#8217;d be tempted to make this a first-class conditional, but I understand that&#8217;s my chef and puppet background at play. I&#8217;m assuming that it&#8217;s intentionally cumbersome to encourage people to check the actual outcomes of actions, not whether a particular file matches. Of course, there&#8217;s cases where file matching is desirable: I don&#8217;t want to manually have to trigger a <code>meet</code> condition if I update a webserver template, for example.</p>

<h2>Thoughts</h2>

<p>I&#8217;m ashamed to admit it, but I&#8217;m nearly at the point where I&#8217;ll need to shelve this project and continue the server rework using chef. Admittedly my expectation that I&#8217;d be able to duplicate a multi-cookbook configuration in babushka within a weekend was fairly optimistic, but I&#8217;ve run in to a couple of things that have made the process a bit more difficult than I&#8217;d anticipated.</p>

<p>I&#8217;d assumed at the outset that babushka deps were written in much the same way as puppet manifests or chef cookbooks: &#8220;I expect this package to be installed, I expect this file to look like this&#8221;. Features and templates seem to have been deliberately ommitted from babushka to encourage a behavorial (rather than merely stateful) approach to depedency creation. While interesting, this has implications for idempotency that I&#8217;d taken for granted in chef and puppet.</p>

<p>There&#8217;s little documentation &#8220;in the wild&#8221; about the best way to structure certain things in babushka. Most of my understanding has been from reading The Conversation&#8217;s deps. Based on conversations with Ben, I&#8217;m beginning to assume that some of the patterns in use there are soon to be deprecated or are non-ideal. Lacking a shared understanding of the right way to do things (which I feel is necessary when learning a new technology: just see how most people ended up using Cucumber!), I&#8217;m left wondering whether I&#8217;m actually spending all my time heading down the wrong path.</p>

<p>However, RailsCamp 12 is coming up next month, and I&#8217;ve been looking for a project to hack on. I&#8217;m considering spending some time adding creating a &#8216;stdlib&#8217; of deps (borrowing from the chef resources) to make migration easier and maybe even work on the documentation.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/27/babushka/">Babushka, Day One</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-27T22:28:00+10:00" pubdate data-updated="true">Sep 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.bikeexchange.com.au">BikeExchange</a> are moving from a Ubuntu 10.04 virtual machine to a Ubuntu 12.04 bare metal behemoth. We have existing chef cookbooks that would make this easier, but:</p>

<ul>
<li>I&#8217;m the only person in the organisation who knows how they work</li>
<li>We use maybe 25% of <a href="http://www.opscode.com/chef/">chef</a> and the other 75% gets in the way</li>
<li>I need to rewrite big chunks from scratch to properly support <a href="http://www.tinitrader.com.au">TiniTrader</a></li>
</ul>


<p>A discussion about <a href="http://ansible.cc/">ansible</a> on <a href="http://freenode.net/">#roro</a> today led me to think about giving that a try instead. Simple YAML files! No daemons! No fucking <a href="http://projects.puppetlabs.com/projects/1/wiki/certificates_and_security">keysigning</a>! Party time!</p>

<p>Then, <a href="https://twitter.com/andy_snow">Andy Snow</a> said (I&#8217;m paraphrasing) &#8220;You&#8217;re a pussy, you should give <a href="http://babushka.me">babushka</a> a go instead.&#8221;</p>

<p>So that this knowledge isn&#8217;t lost, and as the babushka documention is pretty mixed (think Rails 3 before all the <a href="http://guides.rubyonrails.org">guides</a> got re-written), I&#8217;m documenting my experiences converting our chef cookbooks from scratch.</p>

<h2>Bootstrapping Vagrant</h2>

<p><a href="http://vagrantup.com">Vagrant</a> doesn&#8217;t support babushka out of the box, like puppet or chef. I prefer that: while I&#8217;m creating these things I like to work with them live rather than have vagrant do the heavy lifting for me.</p>

<p>My first step was to update <a href="https://www.virtualbox.org">VirtualBox</a> and vagrant. Easy.</p>

<p>I grabbed an official <a href="https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Boxes">Ubuntu 12.04 Precise Pangolin 64-bit image</a>.</p>

<p>Installed babushka, following Ben&#8217;s <a href="http://babushka.me/installing">instructions</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>vagrant ssh
</span><span class='line'>sudo apt-get install curl
</span><span class='line'>sudo bash -c <span class="s2">&quot;`curl https://babushka.me/up`&quot;</span>
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ll be working on my babushka configuration right in my repository, so I set up a symlink between that and where babushka expects to find its configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>vagrant ssh
</span><span class='line'>sudo bash
</span><span class='line'><span class="nb">cd</span> /root/.babushka
</span><span class='line'>ln -si /vagrant/babushka-deps/ deps
</span></code></pre></td></tr></table></div></figure>


<p>So that I didn&#8217;t need to repeat these steps if I wanted to start from a &#8216;fresh&#8217; machine, I packaged what I had as a new vagrant box:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>vagrant package
</span><span class='line'>vagrant box add precise64-babushka package.box
</span><span class='line'><span class="c"># edit Vagrantfile, replace box with precise64-babushka</span>
</span><span class='line'>rm package.box <span class="c"># (don&#39;t need it no more)</span>
</span><span class='line'>vagrant destroy <span class="c"># (as above)</span>
</span><span class='line'>vagrant up
</span></code></pre></td></tr></table></div></figure>


<h3>Proof of Concept Babushka Dep</h3>

<p>Babushka works on a concept of &#8216;deps&#8217;. You specify a condition and how to meet that condition. It&#8217;s got more in common with puppet than chef, and more in common with TDD than both of those.</p>

<p>The very first step in our chef configuration is to lock the timezone to UTC. Let&#8217;s try writing a dep that does just that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;timezone set&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="n">shell</span><span class="p">(</span><span class="s2">&quot;date +%Z&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;UTC&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>root@precise64:/root/.babushka/deps# babushka <span class="s1">&#39;personal:timezone set to UTC&#39;</span>
</span><span class='line'>timezone <span class="nb">set </span>to UTC <span class="o">{</span>
</span><span class='line'><span class="o">}</span> ✓ timezone <span class="nb">set </span>to UTC
</span></code></pre></td></tr></table></div></figure>


<p>Looks like this box is already already UTC! Okay, let&#8217;s paramaterize it and use EST:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;timezone set&quot;</span><span class="p">,</span> <span class="ss">:timezone</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="n">shell</span><span class="p">(</span><span class="s2">&quot;date +%Z&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">timezone</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much better:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>root@precise64:/root/.babushka/deps# babushka <span class="s1">&#39;personal:timezone set&#39;</span> <span class="nv">timezone</span><span class="o">=</span>EST
</span><span class='line'>timezone <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>  meet <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span> ✗ timezone <span class="nb">set</span>
</span><span class='line'>You can view a more detailed log at <span class="s1">&#39;/root/.babushka/logs/timezone set&#39;</span>.
</span><span class='line'>
</span><span class='line'>root@precise64:/root/.babushka/deps# babushka <span class="s1">&#39;personal:timezone set&#39;</span> <span class="nv">timezone</span><span class="o">=</span>UTC
</span><span class='line'>timezone <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span> ✓ timezone <span class="nb">set</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we&#8217;ll grab the commands from our chef config and set the timezone:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dep</span> <span class="s2">&quot;timezone set&quot;</span><span class="p">,</span> <span class="ss">:timezone</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">met?</span> <span class="p">{</span> <span class="n">shell</span><span class="p">(</span><span class="s2">&quot;date +%Z&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">timezone</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">meet</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;/etc/timezone&#39;</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>
</span><span class='line'>    <span class="n">shell</span> <span class="s2">&quot;dpkg-reconfigure --frontend noninteractive tzdata&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'>root@precise64:/root/.babushka/deps# babushka <span class="s1">&#39;personal:timezone set&#39;</span> <span class="nv">timezone</span><span class="o">=</span>EST
</span><span class='line'>timezone <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>  meet <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span> ✓ timezone <span class="nb">set</span>
</span><span class='line'>
</span><span class='line'>root@precise64:/root/.babushka/deps# date
</span><span class='line'>Thu Sep 27 06:59:47 EST 2012
</span></code></pre></td></tr></table></div></figure>


<h2>Additional Resources</h2>

<p>I found the following helpful:</p>

<ul>
<li><a href="https://github.com/benhoskings/babushka">Babushka at GitHub</a></li>
<li><a href="http://babushka.me/how-deps-work">How Deps Work</a>, <a href="http://babushka.me/writing-deps">Writing Deps</a>, <a href="http://babushka.me/dep-examples">Dep Examples</a></li>
<li><a href="https://github.com/conversation/babushka-deps">The Conversation&#8217;s Deps</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/18/reducing-asset-precompilation-time/">Reducing Asset Precompilation Time</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-18T21:10:00+11:00" pubdate data-updated="true">Mar 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We deploy to our test environment generally between five and twenty times a day. As we like our test environment to provide a solid indicator of production-readiness, we try to match our test environment as close to production as we can.</p>

<p>This, of course, means using the same Rails asset precompilation on a test deploy as on a production deploy. Unfortunately, this can take a while:</p>

<pre><code>$ time rake assets:precompile
...
real  4m14.866s
user  5m52.794s
sys   0m31.324s
</code></pre>

<p>Last week I found, fixed and resolved a bug in the time it took for a deployment to complete. This annoyed me, so I set out to see if I could reduce our asset precompilation time, and by extension our deployment time.</p>

<p>First I look in <code>rails/actionpack/lib/sprockets/assets.rake</code> and find one huge smell: the compilation is run twice! It&#8217;s run once for assets, appending a digest path, and then again without a digest path.</p>

<p>Doing a bit of digging on this I find this isn&#8217;t necessary for our case: everything in <code>public/assets</code> is called using one of the asset helpers, which will read <code>manifest.yml</code> and determine the correct (digested) path for the asset. Unless we start using assets from a &#8216;static&#8217; source (eg, from an email) we&#8217;re safe to turn off the &#8216;nondigest&#8217; run. In fact, it looks like there&#8217;s a <a href="https://github.com/rails/rails/pull/5379">movement to make this the default</a>.</p>

<p>Unfortunately, running <code>rake assets:precompile:primary</code> gives us an error about a missing <code>bootstrap-dropdown.js</code>. Investigating further I find that <code>rake assets:precompile</code> does some set up for us. It:</p>

<ul>
<li>sets the Rails environment to <code>production</code>,</li>
<li>ensures that Bundler loads the <code>assets</code> group and</li>
<li>re-invokes rake to apply these changes.</li>
</ul>


<p>Appending <code>RAILS_ENV=production RAILS_GROUPS=assets</code> to our <code>rake assets:precompile:primary</code> command fixes the missing file error.</p>

<p>This halves our precompilation time:</p>

<pre><code>real  2m0.908s
user  2m51.986s
sys   0m14.973s
</code></pre>

<p>Now, let&#8217;s see where Sprockets is spending all of its time. I overrode the <code>Sprockets::StaticCompiler#compile</code> method to print out how long Sprockets spent with each file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TRACK_PRECOMPILE_ASSETS&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Sprockets</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">StaticCompiler</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">compile</span>
</span><span class='line'>        <span class="n">manifest</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">start_process</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>        <span class="n">total_time_taken</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">env</span><span class="o">.</span><span class="n">each_logical_path</span> <span class="k">do</span> <span class="o">|</span><span class="n">logical_path</span><span class="o">|</span>
</span><span class='line'>          <span class="k">next</span> <span class="k">unless</span> <span class="n">compile_path?</span><span class="p">(</span><span class="n">logical_path</span><span class="p">)</span>
</span><span class='line'>          <span class="n">start_file</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">asset</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">find_asset</span><span class="p">(</span><span class="n">logical_path</span><span class="p">)</span>
</span><span class='line'>            <span class="n">post_find</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>            <span class="n">manifest</span><span class="o">[</span><span class="n">logical_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">write_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
</span><span class='line'>            <span class="n">post_write</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>            <span class="n">time_taken</span> <span class="o">=</span> <span class="n">post_write</span> <span class="o">-</span> <span class="n">start_file</span>
</span><span class='line'>            <span class="n">percent_in_write</span> <span class="o">=</span> <span class="p">(</span><span class="n">post_write</span> <span class="o">-</span> <span class="n">post_find</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_taken</span>
</span><span class='line'>            <span class="n">total_time_taken</span> <span class="o">+=</span> <span class="n">time_taken</span>
</span><span class='line'>            <span class="n">time_taken_s</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s2">&quot;%0.2f&quot;</span><span class="p">,</span> <span class="n">time_taken</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span class='line'>            <span class="n">percent_in_write_s</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="s2">&quot;%0.2f&quot;</span><span class="p">,</span> <span class="n">percent_in_write</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'>            <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">logical_path</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">time_taken_s</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">percent_in_write_s</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">write_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@manifest</span>
</span><span class='line'>        <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;TOTAL: </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_process</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">total_time_taken</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Messy as hell, but it&#8217;s done the job for me.</p>

<p>It showed me something interesting: each file that actually needs precompilation (rather than simply copying, as is the case for images) takes between 0.5 seconds and 3 seconds depending on how complex it is.</p>

<p>The gem <code>ckeditor_rails</code> has about 100 or so Javascript files that are being individually compiled. Removing this gem reduces our precompilation time significantly:</p>

<pre><code>real  0m35.728s
user  0m45.032s
sys   0m2.792s
</code></pre>

<p>So, I&#8217;ve taken the time from four minutes to thirty seconds. Let&#8217;s see how that affects our deployment time.</p>

<p>Firstly, we&#8217;ll set a baseline by running chef without a pending deploy:</p>

<pre><code>real  0m24.555s
user  0m1.940s
sys   0m0.560s
</code></pre>

<p>Next a deploy without the above optimisations:</p>

<pre><code>real  4m6.257s
user  3m46.870s
sys   0m24.190s
</code></pre>

<p>Finally, use <code>asset:precompile:primary</code> and remove <code>ckeditor_rails</code>:</p>

<pre><code>real  1m30.535s
user  0m49.960s
sys  0m5.690s
</code></pre>

<p>Four minutes down a much more reasonable one minute thirty! There&#8217;s still work to be done, but this is much better than we started with.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/18/discovering-un-pushed-git-repositories/">Discover Un-Pushed Git Repositories</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-18T23:04:00+10:00" pubdate data-updated="true">Aug 18<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A small script to discover any repositories in the current directory with an un-pushed current branch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="n">pwd</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span>
</span><span class='line'><span class="n">debug</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;-d&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">repo</span><span class="o">|</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\.git$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;in </span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">debug</span>
</span><span class='line'>  <span class="k">if</span> <span class="sb">`cd </span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="sb">; git status`</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;Your branch is ahead of&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">repo</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/16/nginx-error-codes/">Tracking Nginx Error Code Frequency With Munin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-16T23:04:00+10:00" pubdate data-updated="true">Aug 16<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Place this in your <code>/etc/munin/plugins</code>.</p>

<p>You&#8217;ll need to ensure that your <code>/var/nginx/access.log</code> is readable by your <code>munin-node</code> user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="no">CODES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;400&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;401&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;403&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;404&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;405&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;406&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Not Acceptable&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;408&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Request Timeout&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;499&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Client Connection Terminated&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;500&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;502&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bad Gateway&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;503&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Service Unavailable&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;Other&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Other responses&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;config&#39;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;graph_title nginx Error Codes&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;graph_vlabel responses per minute&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;graph_category nginx&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;graph_period minute&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;graph_info Non-200 response codes per minute&quot;</span>
</span><span class='line'>  <span class="no">CODES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="p">,</span> <span class="n">desc</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">code</span><span class="si">}</span><span class="s2">.label </span><span class="si">#{</span><span class="n">code</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">code</span><span class="si">}</span><span class="s2">.type DERIVE&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">code</span><span class="si">}</span><span class="s2">.min 0&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">results</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">[*</span><span class="no">CODES</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="o">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">flatten</span><span class="o">]</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/var/log/nginx/access.log&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/&quot; (\d\d\d)/</span>
</span><span class='line'>      <span class="n">code</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">CODES</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span class='line'>  <span class="n">results</span><span class="o">[</span><span class="n">code</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;=</span> <span class="mi">400</span>
</span><span class='line'>        <span class="n">results</span><span class="o">[</span><span class="s1">&#39;Other&#39;</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">.value </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/08/linode-to-aws-in-sixty-minutes-or-less/">Linode to AWS in Sixty Minutes or Less</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-08T23:14:00+10:00" pubdate data-updated="true">Aug 8<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, <a href="http://yfrog.com/kkrk4p">linode bailed</a> while I was in the middle of
working on the <a href="http://www.thebonscotts.com">band website</a>.</p>

<p>That annoyed me somewhat.</p>

<p>Here&#8217;s what I did to move it off linode in under one hour:</p>

<ol>
<li>Logged in to my (already extant) AWS account</li>
<li>Created an elastic IP</li>
<li>Put in a request for a <code>t1.micro</code> spot instance in <code>ap-southeast-1</code> (have found it to have the least latency for .au clients)</li>
<li>Logged in to linode</li>
<li>Pointed the thebonscotts.com / www.thebonscotts.com A records to the new elastic IP</li>
<li>Waited ~5min for the spot instance to come up</li>
<li>Associated the elastic IP with the spot instance</li>
</ol>


<p>I then logged in to the instance, ran <code>ssh-keygen</code> to create a ssh
key, and added that key to my github project&#8217;s deploy keyset.</p>

<p>I then ran these commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install git-core
</span><span class='line'>wget http://rubyenterpriseedition.googlecode.com/files/ruby-enterprise_1.8.7-2011.03_amd64_ubuntu10.04.deb
</span><span class='line'>sudo dpkg --install ruby-enterprise_1.8.7-2011.03_amd64_ubuntu10.04.deb
</span><span class='line'>sudo gem update --system
</span><span class='line'>sudo gem install bundler --no-rdoc --no-ri
</span><span class='line'>sudo gem install passenger --no-rdoc --no-ri
</span><span class='line'>sudo apt-get install apache2-prefork-dev
</span><span class='line'>sudo apt-get install build-essential libcurl4-openssl-dev zlib1g-dev apache2-mpm-prefork
</span><span class='line'>sudo /usr/local/bin/passenger-install-apache2-module
</span><span class='line'>sudo vim /etc/apache2/sites-available/default
</span><span class='line'>
</span><span class='line'><span class="c"># above I copied in the sections from the passenger install</span>
</span><span class='line'>git clone git@github.com:&lt;REDACTED&gt;
</span><span class='line'>sudo apt-get install memcached
</span><span class='line'>sudo update-rc.d memcached defaults
</span><span class='line'>sudo update-rc.d apache2 defaults
</span><span class='line'><span class="nb">cd </span>bonscotts/
</span><span class='line'>bundle install
</span><span class='line'>sudo /etc/init.d/apache2 restart
</span></code></pre></td></tr></table></div></figure>


<p>Easy!</p>

<p>Probably would have been easier if I&#8217;d had a puppet or chef recipe.</p>

<p>&#8211;</p>

<h3>Postscript</h3>

<p>I didn&#8217;t create a snapshot of the instance. A month later, when the AWS spot instance price exceeded my maximum bid, the instance was terminated and I had to repeat the above process.</p>

<p>Fortunately I had the above instructions archived on <a href="http://gist.github.com">github</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Projects</h1>
  <ul>
    <li>
      <a href="http://github.com/mipearson/gofer.git">Gofer</a>
      <p>a set of wrappers around the Net::SSH suite of tools to enable consistent access to remote systems</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/rails/blob/master/railties/guides/source/kindle/KINDLE.md">Rails Guides for Kindle</a>
      <p>Kindle book generation for the <a href="http://edgeguides.rubyonrails.org/">Ruby on Rails Guides</a>. Now included in the upcoming 3.2 release of Rails!</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/slingshot">slingshot</a>
      <p>Insecure, HTTP-driven script execution for automated application updates.</p>
    </li>
    <li>
      <a href="http://fas2rdf.heroku.com/">fas2rdf</a>
      <p>Online conversion from FAS to RDF sequence alignment format.</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/gnome-breakout">gnome-breakout</a>
      <p>Arkanoid clone for GNOME, circa 1999</p>
    </li>
  </ul>
</section>
<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mipearson">@mipearson</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mipearson',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/">Live Destructive Database Migrations: Doing the Two Step</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/30/babushka/">Babushka, Day Two</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/babushka/">Babushka, Day One</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/18/reducing-asset-precompilation-time/">Reducing Asset Precompilation Time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/18/discovering-un-pushed-git-repositories/">Discover Un-Pushed git Repositories</a>
      </li>
    
  </ul>
</section>

  
</aside>

      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Michael Pearson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'mipearson';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
  <div id="bg0"></div>
  <div id="bg1"></div>
</body>
</html>
