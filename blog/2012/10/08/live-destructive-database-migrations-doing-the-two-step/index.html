
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Live Destructive Database Migrations: Doing the Two Step - Michael Pearson</title>
  <meta name="author" content="Michael Pearson">

  
  <meta name="description" content="By &#8221;destructive&#8221;, I mean &#8220;removes or renames a column in use by the current application&#8221;. By &#8221;live&#8221;, I mean &# &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mipearson.github.com//blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/coffee-script.js"></script>
  <script type="text/coffeescript" src="/javascripts/bg.coffee"></script>
  <link href="/atom.xml" rel="alternate" title="Michael Pearson" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17899518-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div  id="body"  >
  
    <header role="banner"><hgroup>
  <h1><a href="/">Michael Pearson</a></h1>
  
    <h2>Systems Automation and Web Development</h2>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mipearson.github.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Live Destructive Database Migrations: Doing the Two Step</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-08T07:43:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>By &#8221;<strong>destructive</strong>&#8221;, I mean &#8220;removes or renames a column in use by the current application&#8221;. By &#8221;<strong>live</strong>&#8221;, I mean &#8220;while your application is in use&#8221;.</p>

<h2>Original Migration</h2>

<p>If Rails&#8217; ActiveRecord notices that a table has the columns <code>created_at</code> and <code>updated_at</code> it will automatically populate or change their values on model creation or modification. Our application doesn&#8217;t take advantage of this: it uses a hand-rolled <code>creation_date</code> field. I&#8217;m going to change this column to <code>created_at</code> and add an <code>updated_at</code> column.</p>

<p>If I were doing this via downtime and maintenance page the migration would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddCreatedUpdatedColumns</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2"> SET updated_at = created_at&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This migration couldn&#8217;t be run on a live system. Between the time that the schema begins to be changed and the application restarts these errors would occur:</p>

<ul>
<li>ActiveRecord would try to set values on a creation_date column that no longer exists</li>
<li>Scopes that have <code>order(:creation_date)</code> stanzas would fail to load entirely</li>
</ul>


<h2>Do the Two-Step</h2>

<p>To work around this I&#8217;m going to split the above migration and prepare for multiple deployments:</p>

<ul>
<li><p>My first migration will create new <code>created_at</code> and <code>updated_at</code> columns and deploy code to use these new columns instead.</p></li>
<li><p>My second migration will remove the now unused <code>creation_date</code> column.</p></li>
</ul>


<p>Simple, yeah? I let our running application use the new column name before I remove the old one.</p>

<h3>Our First Migration</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddCreatedUpdatedColums</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="s2">&quot;DEFAULT now() NOT NULL&quot;</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="s2">&quot;DEFAULT now() NOT NULL&quot;</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2"> SET created_at = creation_date, updated_at = creation_date&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="sx">%w{all the tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span>
</span><span class='line'>      <span class="n">drop_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once I&#8217;ve run <code>rake db:migrate</code>  on my development box I&#8217;ll run a global find and replace all instances of <code>creation_date</code> with <code>created_at</code>. I&#8217;ll then run our test suite and commit.</p>

<p>I&#8217;ll push that out to our test system, play around with some records to make sure that <code>created_at</code> and <code>updated_at</code> get set properly, and then push it to production.</p>

<h3>Our Second Migration</h3>

<p>In the above case the first migration would take up to five minutes to run on our slow fixed HDDs in production. While it was running I created a branch to write our second migration, just in case I needed to fix something in <code>master</code> before pushing this new migration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">RemoveCreationDate</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="sx">%w{some tables}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">change_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:datetime</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="n">table</span><span class="p">,</span> <span class="ss">:creation_date</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">IrreversibleMigration</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the use of <code>IrreversibleMigration</code> above. I prefer to flag that a migration can&#8217;t be reversed this way rather than leave a <code>down</code> method that provides a false positive. I will also remove the <code>DEFAULT now()</code>: ActiveRecord will always set these values, any other behaviour should be considered an error.</p>

<p>This migration gets pushed to our test system only when the first migration and deploy has successfully run on both our test and production systems and all automated tests have passed.</p>

<h2>Gotchas</h2>

<p>The code above has been adapted based on a couple of things that went wrong during pre-production testing:</p>

<ul>
<li>The created columns were set to <code>:null =&gt; true</code> rather than having intelligent defaults. This gave us some grief after the first migration was run: some code depended on <code>creation_date</code> &amp; <code>created_at</code> not being nil.</li>
<li>I&#8217;d forgotten to change <code>creation_date</code> to allow nulls in the first migration. This meant that once the new code was deployed records were being saved without a <code>creation_date</code>, causing MySQL to return a <code>column 'creation_date' cannot be NULL</code> failure.</li>
</ul>


<p>I also had to modify an existing index and manually re-create a couple of views. Check your <code>db/schema.rb</code> diff after you run <code>rake migrate</code> on your own machine before pushing.</p>

<p>In our codebase migrations are immutable one they hit pre-production, so they&#8217;re there for other BikeExchange developers to point and laugh forever (or until the next old-migrations purge).</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Michael Pearson</span></span>

      








  


<time datetime="2012-10-08T07:43:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mipearson.github.com//blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/" data-via="mipearson" data-counturl="http://mipearson.github.com//blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/09/30/babushka/" title="Previous Post: Babushka, Day Two">&laquo; Babushka, Day Two</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Projects</h1>
  <ul>
    <li>
      <a href="http://github.com/mipearson/gofer.git">Gofer</a>
      <p>a set of wrappers around the Net::SSH suite of tools to enable consistent access to remote systems</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/rails/blob/master/railties/guides/source/kindle/KINDLE.md">Rails Guides for Kindle</a>
      <p>Kindle book generation for the <a href="http://edgeguides.rubyonrails.org/">Ruby on Rails Guides</a>. Now included in the upcoming 3.2 release of Rails!</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/slingshot">slingshot</a>
      <p>Insecure, HTTP-driven script execution for automated application updates.</p>
    </li>
    <li>
      <a href="http://fas2rdf.heroku.com/">fas2rdf</a>
      <p>Online conversion from FAS to RDF sequence alignment format.</p>
    </li>
    <li>
      <a href="https://github.com/mipearson/gnome-breakout">gnome-breakout</a>
      <p>Arkanoid clone for GNOME, circa 1999</p>
    </li>
  </ul>
</section>
<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mipearson">@mipearson</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mipearson',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/">Live Destructive Database Migrations: Doing the Two Step</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/30/babushka/">Babushka, Day Two</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/babushka/">Babushka, Day One</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/18/reducing-asset-precompilation-time/">Reducing Asset Precompilation Time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/18/discovering-un-pushed-git-repositories/">Discover Un-Pushed git Repositories</a>
      </li>
    
  </ul>
</section>

  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Michael Pearson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'mipearson';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mipearson.github.com//blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/';
        var disqus_url = 'http://mipearson.github.com//blog/2012/10/08/live-destructive-database-migrations-doing-the-two-step/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
  <div id="bg0"></div>
  <div id="bg1"></div>
</body>
</html>
